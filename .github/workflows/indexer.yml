name: PRISM Indexer
run-name: PRISM Indexer

on:
  workflow_dispatch:
    inputs:
      network:
        description: "network: mainnet|preprod"
        required: true
        type: choice
        default: 'mainnet'
        options: 
        - mainnet
        - preprod
  schedule: # Every hour
    - cron: "* */1 * * *"
  # push:
  #   branches: [master,main]
  #   tags: ["v*"]

jobs:
  indexer-job:
    name: Indexer job
    runs-on: ubuntu-latest
    permissions:
      # Give the default GITHUB_TOKEN write permission to commit and push the added or changed files to the repository.
      contents: write
    # container:
    #   image: fmgp/prism-indexer:latest
    #   #env:
    #   #volumes:
    #   #options: --cpus 1
    steps:
      - uses: actions/cache@v4
        with:
          path: .
          key: cache-git
      - uses: actions/checkout@v4
        # with:
        #   fetch-depth: 0 # Needed for the release tag // `git fetch --tags` will also work
      - name: Run Indexer inside Docker
        uses: addnab/docker-run-action@v3
        with:
            image: fmgp/prism-indexer:latest
            options: -v ${{ github.workspace }}/${{ inputs.network || 'mainnet' }}:/data
            run: java -XX:+UseContainerSupport -jar /prism-indexer.jar ./data ${{inputs.network || 'mainnet'}} ${{ secrets.APIKEY }}
      # - name: Indexer
      #   run: java -XX:+UseContainerSupport -jar /prism-indexer.jar ./${{inputs.network || 'mainnet'}} ${{inputs.network || 'mainnet'}} ${{ secrets.APIKEY }}
        #docker run --rm -it --entrypoint "sh" --memory="300m" --cpus="1.0" --volume ./mainnet:/data fmgp/prism-indexer -c "java -XX:+UseContainerSupport -jar prism-indexer.jar /data mainnet $APIKEY"
      - run: |
          git status

      - uses: stefanzweifel/git-auto-commit-action@v5
        id: auto-commit-action
        with:
          commit_message: Indexer job (${{inputs.network || 'mainnet'}})
      - name: "Run if changes have been detected"
        if: steps.auto-commit-action.outputs.changes_detected == 'true'
        run: echo "Changes!"
      
      - name: "Run if no changes have been detected"
        if: steps.auto-commit-action.outputs.changes_detected == 'false'
        run: echo "No Changes!"